/*********************************************************************************************************************/
/*-----------------------------------------------------Includes------------------------------------------------------*/
/*********************************************************************************************************************/
#include "Ifx_Types.h"
#include "observer.h"
#include "commonMacros.h"
#include "lpf.h"

/*********************************************************************************************************************/
/*------------------------------------------------------Macros-------------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*-------------------------------------------------Global variables--------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*--------------------------------------------Private Variables/Constants--------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*------------------------------------------------Function Prototypes------------------------------------------------*/
/*********************************************************************************************************************/

/*********************************************************************************************************************/
/*---------------------------------------------Function Implementations----------------------------------------------*/
/*********************************************************************************************************************/

void taskMotorCtrl(float32 w_ref, uint8 motor_on, uint8 dir)
{
    /* 모터별 목표 각속도 (rad/s) */
    float32 w_ref_1 = 0.0f;
    float32 w_ref_2 = 0.0f;

    /* 옵저버 측정 각속도 (rad/s) */
    float32 w_1 = 0.0f;
    float32 w_2 = 0.0f;

    /* 필터를 거친 각속도 (rad/s) */
    float32 w_lpf_1 = 0.0f;
    float32 w_lpf_2 = 0.0f;

    /* LPF를 위한 이전 각속도 (rad/s) */
    static float32 w_lpf_prev_1 = 0.0f;
    static float32 w_lpf_prev_2 = 0.0f;

    /* 목표 각속도와 실제 각속도 사이의 오차 (rad/s) */
    float32 w_err_1 = 0.0f;
    float32 w_err_2 = 0.0f;

    /* 모터에 인가할 전압 (V) */
    float32 v_in_1 = 0.0f;
    float32 v_in_2 = 0.0f;

    /* 태스크 실행 주기 */
    const float32 t_s = 0.001f;

    /* 1번 모터와 2번 모터의 회전 방향은 반대 */
    w_ref_1 = -1.0f * w_ref;
    w_ref_2 = w_ref;

    /* 관측기로 w_hat 측정 */
    w_1 = getWHat(MOTOR1);
    w_2 = getWHat(MOTOR2);

    /* LPF 각속도 필터링 */
    w_lpf_1 = lowPassFilter(w_lpf_1, w_lpf_prev_1, t_s);
    w_lpf_2 = lowPassFilter(w_lpf_2, w_lpf_prev_2, t_s);

    w_lpf_prev_1 = w_lpf_1;
    w_lpf_prev_2 = w_lpf_2;

    /* 오차 계산 */
    w_err_1 = w_ref_1 - w_lpf_1;
    w_err_2 = w_ref_2 - w_lpf_2;
}

void taskBuzzerCtrl(uint8 buzzer_on, uint8 motor_on);
void taskUltrasonic(float32 *w_ref, float32 *dist, uint8 motor_on);
void taskBuzzerMode(uint32 time_100ms, float32 dist, uint8 *buzzer_on);
void taskBluetooth(uint8 *bt_on, uint8 *motor_on, uint32 time_100ms, float32 *w_ref, uint8 *dir);
void taskSW(uint8 bt_on, uint8 *motor_on);
void taskDial(uint8 bt_on, uint8 motor_on, float32 dist, float32 *w_ref);
